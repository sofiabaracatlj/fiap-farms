<!DOCTYPE html>
<html>
<head>
  <title>zipFile.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/adm-zip/zipFile.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>zipFile.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> ZipEntry = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./zipEntry"</span>);
<span class="hljs-keyword">const</span> Headers = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./headers"</span>);
<span class="hljs-keyword">const</span> Utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./util"</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*Buffer|null*/</span> inBuffer, <span class="hljs-regexp">/** object */</span> options</span>) </span>{
    <span class="hljs-keyword">var</span> entryList = [],
        entryTable = {},
        _comment = Buffer.alloc(<span class="hljs-number">0</span>),
        mainHeader = <span class="hljs-keyword">new</span> Headers.MainHeader(),
        loadedEntries = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> password = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> temporary = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>assign options</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> opts = options;

    <span class="hljs-keyword">const</span> { noSort, decoder } = opts;

    <span class="hljs-keyword">if</span> (inBuffer) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>is a memory buffer</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        readMainHeader(opts.readEntries);
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>none. is a new file</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        loadedEntries = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeTemporaryFolders</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> foldersList = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Make list of all folders in file</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> elem <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.keys(entryTable)) {
            <span class="hljs-keyword">const</span> elements = elem.split(<span class="hljs-string">"/"</span>);
            elements.pop(); <span class="hljs-comment">// filename</span>
            <span class="hljs-keyword">if</span> (!elements.length) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// no folders</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; elements.length; i++) {
                <span class="hljs-keyword">const</span> sub = elements.slice(<span class="hljs-number">0</span>, i + <span class="hljs-number">1</span>).join(<span class="hljs-string">"/"</span>) + <span class="hljs-string">"/"</span>;
                foldersList.add(sub);
            }
        }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>create missing folders as temporary</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> elem <span class="hljs-keyword">of</span> foldersList) {
            <span class="hljs-keyword">if</span> (!(elem <span class="hljs-keyword">in</span> entryTable)) {
                <span class="hljs-keyword">const</span> tempfolder = <span class="hljs-keyword">new</span> ZipEntry(opts);
                tempfolder.entryName = elem;
                tempfolder.attr = <span class="hljs-number">0x10</span>;
                tempfolder.temporary = <span class="hljs-literal">true</span>;
                entryList.push(tempfolder);
                entryTable[tempfolder.entryName] = tempfolder;
                temporary.add(tempfolder);
            }
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readEntries</span>(<span class="hljs-params"></span>) </span>{
        loadedEntries = <span class="hljs-literal">true</span>;
        entryTable = {};
        <span class="hljs-keyword">if</span> (mainHeader.diskEntries &gt; (inBuffer.length - mainHeader.offset) / Utils.Constants.CENHDR) {
            <span class="hljs-keyword">throw</span> Utils.Errors.DISK_ENTRY_TOO_LARGE();
        }
        entryList = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(mainHeader.diskEntries); <span class="hljs-comment">// total number of entries</span>
        <span class="hljs-keyword">var</span> index = mainHeader.offset; <span class="hljs-comment">// offset of first CEN header</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; entryList.length; i++) {
            <span class="hljs-keyword">var</span> tmp = index,
                entry = <span class="hljs-keyword">new</span> ZipEntry(opts, inBuffer);
            entry.header = inBuffer.slice(tmp, (tmp += Utils.Constants.CENHDR));

            entry.entryName = inBuffer.slice(tmp, (tmp += entry.header.fileNameLength));

            <span class="hljs-keyword">if</span> (entry.header.extraLength) {
                entry.extra = inBuffer.slice(tmp, (tmp += entry.header.extraLength));
            }

            <span class="hljs-keyword">if</span> (entry.header.commentLength) entry.comment = inBuffer.slice(tmp, tmp + entry.header.commentLength);

            index += entry.header.centralHeaderSize;

            entryList[i] = entry;
            entryTable[entry.entryName] = entry;
        }
        temporary.clear();
        makeTemporaryFolders();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readMainHeader</span>(<span class="hljs-params"><span class="hljs-regexp">/*Boolean*/</span> readNow</span>) </span>{
        <span class="hljs-keyword">var</span> i = inBuffer.length - Utils.Constants.ENDHDR, <span class="hljs-comment">// END header size</span>
            max = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, i - <span class="hljs-number">0xffff</span>), <span class="hljs-comment">// 0xFFFF is the max zip file comment length</span>
            n = max,
            endStart = inBuffer.length,
            endOffset = <span class="hljs-number">-1</span>, <span class="hljs-comment">// Start offset of the END header</span>
            commentEnd = <span class="hljs-number">0</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>option to search header form entire file</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> trailingSpace = <span class="hljs-keyword">typeof</span> opts.trailingSpace === <span class="hljs-string">"boolean"</span> ? opts.trailingSpace : <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (trailingSpace) max = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (i; i &gt;= n; i--) {
            <span class="hljs-keyword">if</span> (inBuffer[i] !== <span class="hljs-number">0x50</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// quick check that the byte is 'P'</span>
            <span class="hljs-keyword">if</span> (inBuffer.readUInt32LE(i) === Utils.Constants.ENDSIG) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>&quot;PK\005\006&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                endOffset = i;
                commentEnd = i;
                endStart = i + Utils.Constants.ENDHDR;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>We already found a regular signature, let's look just a bit further to check if there's any zip64 signature</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                n = i - Utils.Constants.END64HDR;
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (inBuffer.readUInt32LE(i) === Utils.Constants.END64SIG) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Found a zip64 signature, let's continue reading the whole zip64 record</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                n = max;
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (inBuffer.readUInt32LE(i) === Utils.Constants.ZIP64SIG) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Found the zip64 record, let's determine it's size</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                endOffset = i;
                endStart = i + Utils.readBigUInt64LE(inBuffer, i + Utils.Constants.ZIP64SIZE) + Utils.Constants.ZIP64LEAD;
                <span class="hljs-keyword">break</span>;
            }
        }

        <span class="hljs-keyword">if</span> (endOffset == <span class="hljs-number">-1</span>) <span class="hljs-keyword">throw</span> Utils.Errors.INVALID_FORMAT();

        mainHeader.loadFromBinary(inBuffer.slice(endOffset, endStart));
        <span class="hljs-keyword">if</span> (mainHeader.commentLength) {
            _comment = inBuffer.slice(commentEnd + Utils.Constants.ENDHDR);
        }
        <span class="hljs-keyword">if</span> (readNow) readEntries();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sortEntries</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (entryList.length &gt; <span class="hljs-number">1</span> &amp;&amp; !noSort) {
            entryList.sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.entryName.toLowerCase().localeCompare(b.entryName.toLowerCase()));
        }
    }

    <span class="hljs-keyword">return</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>Returns an array of ZipEntry objects existent in the current opened archive</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>Array
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">get</span> entries() {
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                readEntries();
            }
            <span class="hljs-keyword">return</span> entryList.filter(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> !temporary.has(e));
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<div class="dox">
<div class="summary">
<p>Archive comment</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">String</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">get</span> comment() {
            <span class="hljs-keyword">return</span> decoder.decode(_comment);
        },
        <span class="hljs-keyword">set</span> comment(val) {
            _comment = Utils.toBuffer(val, decoder.encode);
            mainHeader.commentLength = _comment.length;
        },

        <span class="hljs-attr">getEntryCount</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                <span class="hljs-keyword">return</span> mainHeader.diskEntries;
            }

            <span class="hljs-keyword">return</span> entryList.length;
        },

        <span class="hljs-attr">forEach</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
            <span class="hljs-keyword">this</span>.entries.forEach(callback);
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<div class="dox">
<div class="summary">
<p>Returns a reference to the entry with the given name or null if entry is inexistent</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entryName</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>ZipEntry
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getEntry: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*String*/</span> entryName</span>) </span>{
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                readEntries();
            }
            <span class="hljs-keyword">return</span> entryTable[entryName] || <span class="hljs-literal">null</span>;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<div class="dox">
<div class="summary">
<p>Adds the given entry to the entry list</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entry</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        setEntry: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*ZipEntry*/</span> entry</span>) </span>{
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                readEntries();
            }
            entryList.push(entry);
            entryTable[entry.entryName] = entry;
            mainHeader.totalEntries = entryList.length;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<div class="dox">
<div class="summary">
<p>Removes the file with the given name from the entry list.</p>
</div>
<div class="body">
<p>If the entry is a directory, then all nested files and directories will be removed</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entryName</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        deleteFile: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*String*/</span> entryName, withsubfolders = true</span>) </span>{
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                readEntries();
            }
            <span class="hljs-keyword">const</span> entry = entryTable[entryName];
            <span class="hljs-keyword">const</span> list = <span class="hljs-keyword">this</span>.getEntryChildren(entry, withsubfolders).map(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> child.entryName);

            list.forEach(<span class="hljs-keyword">this</span>.deleteEntry);
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<div class="dox">
<div class="summary">
<p>Removes the entry with the given name from the entry list.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entryName</span>
<span class="dox_type">string</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        deleteEntry: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*String*/</span> entryName</span>) </span>{
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                readEntries();
            }
            <span class="hljs-keyword">const</span> entry = entryTable[entryName];
            <span class="hljs-keyword">const</span> index = entryList.indexOf(entry);
            <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
                entryList.splice(index, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">delete</span> entryTable[entryName];
                mainHeader.totalEntries = entryList.length;
            }
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<div class="dox">
<div class="summary">
<p>Iterates and returns all nested files and directories of the given entry</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entry</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>Array
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getEntryChildren: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*ZipEntry*/</span> entry, subfolders = true</span>) </span>{
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                readEntries();
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> entry === <span class="hljs-string">"object"</span>) {
                <span class="hljs-keyword">if</span> (entry.isDirectory &amp;&amp; subfolders) {
                    <span class="hljs-keyword">const</span> list = [];
                    <span class="hljs-keyword">const</span> name = entry.entryName;

                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> zipEntry <span class="hljs-keyword">of</span> entryList) {
                        <span class="hljs-keyword">if</span> (zipEntry.entryName.startsWith(name)) {
                            list.push(zipEntry);
                        }
                    }
                    <span class="hljs-keyword">return</span> list;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> [entry];
                }
            }
            <span class="hljs-keyword">return</span> [];
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<div class="dox">
<div class="summary">
<p>How many child elements entry has</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entry</span>
<span class="dox_type">ZipEntry</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">integer</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getChildCount: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
            <span class="hljs-keyword">if</span> (entry &amp;&amp; entry.isDirectory) {
                <span class="hljs-keyword">const</span> list = <span class="hljs-keyword">this</span>.getEntryChildren(entry);
                <span class="hljs-keyword">return</span> list.includes(entry) ? list.length - <span class="hljs-number">1</span> : list.length;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>Returns the zip file</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>Buffer
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        compressToBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (!loadedEntries) {
                readEntries();
            }
            sortEntries();

            <span class="hljs-keyword">const</span> dataBlock = [];
            <span class="hljs-keyword">const</span> headerBlocks = [];
            <span class="hljs-keyword">let</span> totalSize = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">let</span> dindex = <span class="hljs-number">0</span>;

            mainHeader.size = <span class="hljs-number">0</span>;
            mainHeader.offset = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">let</span> totalEntries = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> <span class="hljs-keyword">this</span>.entries) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>compress data and set local and entry header accordingly. Reason why is called first</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">const</span> compressedData = entry.getCompressedData();
                entry.header.offset = dindex;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<ol>
<li>construct local header</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">const</span> localHeader = entry.packLocalHeader();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<ol start="2">
<li>offsets</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">const</span> dataLength = localHeader.length + compressedData.length;
                dindex += dataLength;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<ol start="3">
<li>store values in sequence</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                dataBlock.push(localHeader);
                dataBlock.push(compressedData);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<ol start="4">
<li>construct central header</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">const</span> centralHeader = entry.packCentralHeader();
                headerBlocks.push(centralHeader);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<ol start="5">
<li>update main header</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                mainHeader.size += centralHeader.length;
                totalSize += dataLength + centralHeader.length;
                totalEntries++;
            }

            totalSize += mainHeader.mainHeaderSize; <span class="hljs-comment">// also includes zip file comment length</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>point to end of data and beginning of central directory first record</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            mainHeader.offset = dindex;
            mainHeader.totalEntries = totalEntries;

            dindex = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">const</span> outBuffer = Buffer.alloc(totalSize);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>write data blocks</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> content <span class="hljs-keyword">of</span> dataBlock) {
                content.copy(outBuffer, dindex);
                dindex += content.length;
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>write central directory entries</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> content <span class="hljs-keyword">of</span> headerBlocks) {
                content.copy(outBuffer, dindex);
                dindex += content.length;
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>write main header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">const</span> mh = mainHeader.toBinary();
            <span class="hljs-keyword">if</span> (_comment) {
                _comment.copy(mh, Utils.Constants.ENDHDR); <span class="hljs-comment">// add zip file comment</span>
            }
            mh.copy(outBuffer, dindex);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>Since we update entry and main header offsets,
they are no longer valid and we have to reset content
(Issue 64)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
            inBuffer = outBuffer;
            loadedEntries = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">return</span> outBuffer;
        },

        <span class="hljs-attr">toAsyncBuffer</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*Function*/</span> onSuccess, <span class="hljs-regexp">/*Function*/</span> onFail, <span class="hljs-regexp">/*Function*/</span> onItemStart, <span class="hljs-regexp">/*Function*/</span> onItemEnd</span>) </span>{
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (!loadedEntries) {
                    readEntries();
                }
                sortEntries();

                <span class="hljs-keyword">const</span> dataBlock = [];
                <span class="hljs-keyword">const</span> centralHeaders = [];
                <span class="hljs-keyword">let</span> totalSize = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">let</span> dindex = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">let</span> totalEntries = <span class="hljs-number">0</span>;

                mainHeader.size = <span class="hljs-number">0</span>;
                mainHeader.offset = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">const</span> compress2Buffer = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entryLists</span>) </span>{
                    <span class="hljs-keyword">if</span> (entryLists.length &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">const</span> entry = entryLists.shift();
                        <span class="hljs-keyword">const</span> name = entry.entryName + entry.extra.toString();
                        <span class="hljs-keyword">if</span> (onItemStart) onItemStart(name);
                        entry.getCompressedDataAsync(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">compressedData</span>) </span>{
                            <span class="hljs-keyword">if</span> (onItemEnd) onItemEnd(name);
                            entry.header.offset = dindex;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<ol>
<li>construct local header</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                            <span class="hljs-keyword">const</span> localHeader = entry.packLocalHeader();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<ol start="2">
<li>offsets</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                            <span class="hljs-keyword">const</span> dataLength = localHeader.length + compressedData.length;
                            dindex += dataLength;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<ol start="3">
<li>store values in sequence</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">                            dataBlock.push(localHeader);
                            dataBlock.push(compressedData);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>central header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                            <span class="hljs-keyword">const</span> centalHeader = entry.packCentralHeader();
                            centralHeaders.push(centalHeader);
                            mainHeader.size += centalHeader.length;
                            totalSize += dataLength + centalHeader.length;
                            totalEntries++;

                            compress2Buffer(entryLists);
                        });
                    } <span class="hljs-keyword">else</span> {
                        totalSize += mainHeader.mainHeaderSize; <span class="hljs-comment">// also includes zip file comment length</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>point to end of data and beginning of central directory first record</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                        mainHeader.offset = dindex;
                        mainHeader.totalEntries = totalEntries;

                        dindex = <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">const</span> outBuffer = Buffer.alloc(totalSize);
                        dataBlock.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">content</span>) </span>{
                            content.copy(outBuffer, dindex); <span class="hljs-comment">// write data blocks</span>
                            dindex += content.length;
                        });
                        centralHeaders.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">content</span>) </span>{
                            content.copy(outBuffer, dindex); <span class="hljs-comment">// write central directory entries</span>
                            dindex += content.length;
                        });

                        <span class="hljs-keyword">const</span> mh = mainHeader.toBinary();
                        <span class="hljs-keyword">if</span> (_comment) {
                            _comment.copy(mh, Utils.Constants.ENDHDR); <span class="hljs-comment">// add zip file comment</span>
                        }

                        mh.copy(outBuffer, dindex); <span class="hljs-comment">// write main header</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>Since we update entry and main header offsets, they are no
longer valid and we have to reset content using our new buffer
(Issue 64)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
                        inBuffer = outBuffer;
                        loadedEntries = <span class="hljs-literal">false</span>;

                        onSuccess(outBuffer);
                    }
                };

                compress2Buffer(<span class="hljs-built_in">Array</span>.from(<span class="hljs-keyword">this</span>.entries));
            } <span class="hljs-keyword">catch</span> (e) {
                onFail(e);
            }
        }
    };
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
